<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elimina il tuo account di Athena</title>
    <!-- Load Firebase SDKs as modules -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, EmailAuthProvider, reauthenticateWithCredential } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js';
        import { getFirestore, doc, deleteDoc, collection, getDocs, query, orderBy, writeBatch } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js';

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDwO1LjiEyVs0SpOIjRjdSDbWZP0XCN8YE",
            authDomain: "athena-61f55.firebaseapp.com",
            projectId: "athena-61f55",
            storageBucket: "athena-61f55.appspot.com",
            messagingSenderId: "573365943082",
            appId: "1:573365943082:web:3ea9ed0bcff7f4d5f53c53",
            measurementId: "G-GKMH6R9RHJ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const firestore = getFirestore(app);

        // Recursive function to delete a document and its subcollections
        async function deleteDocumentAndSubcollections(docPath) {
            const docRef = doc(firestore, docPath);

            // Create a batch operation
            const batch = writeBatch(firestore);

            // Fetch all documents in the collection
            async function deleteSubcollections(docRef) {
                const subcollections = await getDocs(collection(firestore, docRef.path));
                const promises = [];

                // Process each document in the subcollection
                subcollections.forEach(async (doc) => {
                    const docRef = doc.ref;
                    const subcollections = await getDocs(collection(firestore, docRef.path));

                    // Recursively delete subcollections
                    subcollections.forEach(subDoc => {
                        promises.push(deleteSubcollections(subDoc.ref));
                    });

                    batch.delete(docRef); // Delete the document itself
                });

                await Promise.all(promises); // Wait for all subcollection deletions
            }

            await deleteSubcollections(docRef);

            await batch.commit(); // Commit the batch operation
            await deleteDoc(docRef); // Delete the document itself
        }

        // Handle form submission
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('delete-account-form').addEventListener('submit', async function (event) {
                event.preventDefault(); // Prevent form from refreshing the page

                // Get user input
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                try {
                    // Sign in user with email and password
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    // Re-authenticate the user
                    const credentials = EmailAuthProvider.credential(email, password);
                    await reauthenticateWithCredential(user, credentials);

                    // Delete Firestore data under /Users/{uid}
                    const uid = user.uid;
                    await deleteDocumentAndSubcollections(`Users/${uid}`);

                    // Delete user account
                    await deleteDoc(doc(firestore, `Users/${uid}`));

                    document.getElementById('message').innerText = "Your account and all associated data have been deleted.";
                } catch (error) {
                    console.error("Error: ", error);
                    document.getElementById('message').innerText = "Failed to delete account: " + error.message;
                }
            });
        });
    </script>
</head>
<body>
    <h2>Elimina il tuo account di Athena</h2>

    <!-- Form for user credentials -->
    <form id="delete-account-form">
        <label for="email">Email:</label>
        <input type="email" id="email" placeholder="Inserire email" required><br><br>

        <label for="password">Password:</label>
        <input type="password" id="password" placeholder="Inserire password" required><br><br>

        <button type="submit">Elimina account e dati</button>
    </form>

    <p id="message"></p>
</body>
</html>
